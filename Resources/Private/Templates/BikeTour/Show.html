{namespace neos=Neos\Neos\ViewHelpers}
{namespace media=Neos\Media\ViewHelpers}

{neos:contentElement.editable(property: 'headline', tag: 'h1', class: '', node: node)}

<div id="track{node.cssId}" node="{node.cssId}" class="gmapTracks"></div>

<div class="totals row">
	<div class="small-4 medium-4 large-4 columns">
		<div class="block">
			<i class="icon fi-distance"></i> <div class="center">{distance} km</div>
		</div>
	</div>
	<div class="small-4 medium-4 large-4 columns">
		<div class="block">
			<i class="icon fi-blind"></i><div class="center">{average_speed} km/h</div>
		</div>
	</div>
	<div class="small-4 medium-4 large-4 columns">
		<div class="block">
			<i class="icon fi-clock"></i><div class="center">{time}</div>
		</div>
	</div>
</div>

<div class="dygraphWrap">
	<div id="graph{node.cssId}" class="dygraph" node="{node.cssId}" style="width: 100%; height: 200px"></div>
</div>

<script type="text/javascript">
GMAP{node.cssId} = [
<f:for each="{coord}" as="poi" iteration="iterator">
	<f:if condition="{iterator.isLast}">
		<f:then>
			[{poi.0}, {poi.1}]
		</f:then>
		<f:else>
			[{poi.0}, {poi.1}],
		</f:else>
	</f:if>
</f:for>
]

DYGRAPH{node.cssId} = [
<f:for each="{elevation}" as="value" iteration="iterator">
	<f:if condition="{iterator.isLast}">
		<f:then>
			[new Date("{value.0}"), {value.1}, {value.2}]
		</f:then>
		<f:else>
			[new Date("{value.0}"), {value.1}, {value.2}],
		</f:else>
	</f:if>
</f:for>
]

$(document).ready(function() {
	
	var mapId = $("#track{node.cssId}");
	var path = eval('GMAP{node.cssId}');
	var line = eval('GMAP{node.cssId}');
	var startPosition = new google.maps.LatLng(line[0][0],line[0][1]);

	marker = new google.maps.Marker({
		position: startPosition,
		title: "My Marker"
	});


	$(mapId).gmap3({
		address:"Paris, France",
		zoom: 10,
		mapTypeId: google.maps.MapTypeId.HYBRID,
		mapTypeControl: true,
		mapTypeControlOptions: {
			style: google.maps.MapTypeControlStyle.DROPDOWN_MENU
		},
		navigationControl: true,
		scrollwheel: true,
		streetViewControl: true
	}).polyline({
		strokeColor: "#FF0000",
		strokeOpacity: 1.0,
		strokeWeight: 2,
		path: line
	}).marker(marker).fit();

//	function markerPos() {
//		var newPosition = new google.maps.LatLng(-12.042, -78.028333);
//		marker.setPosition(newPosition);
//	}


	new Dygraph(document.getElementById("graph{node.cssId}"),
	          eval('DYGRAPH{node.cssId}'),
	          {
	            labels: ["Date", "Elevation", "Speed km/h" ],
	            showRangeSelector: true,
				highlightCallback: function(e, x, pts, row) {
					var newPosition = new google.maps.LatLng(-12.042, -78.028333);
					marker.setPosition(newPosition);
					console.log(row);
				},
	            series : {
	              'Date': { axis: 'y1' },
	              'Elevation': { axis: 'y2' }
	            },
	            axes: {
	              y2: {
	                // set axis-related properties here
	                labelsKMB: true
	              }
	            },
	            ylabel: 'Speed',
	            y2label: 'Elevation'
	          }
	);
});

</script>