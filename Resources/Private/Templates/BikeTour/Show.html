{namespace neos=TYPO3\Neos\ViewHelpers}
{namespace media=TYPO3\Media\ViewHelpers}
<h1>{headline}</h1>

<div id="track{currentNode}" node="{currentNode}" class="gmapTracks"></div>

<div class="totals row">
	<div class="small-4 medium-4 large-4 columns">
		<div class="block">
			<i class="icon fi-distance"></i> <div class="center">{distance} km</div>
		</div>
	</div>
	<div class="small-4 medium-4 large-4 columns">
		<div class="block">
			<i class="icon fi-blind"></i><div class="center">{average_speed} km/h</div>
		</div>
	</div>
	<div class="small-4 medium-4 large-4 columns">
		<div class="block">
			<i class="icon fi-clock"></i><div class="center">{time}</div>
		</div>
	</div>
</div>

<div class="dygraphWrap">
	<div id="graph{currentNode}" class="dygraph" node="{currentNode}" style="width: 100%; height: 200px"></div>
</div>

<script type="text/javascript">
GMAP{currentNode}= [
<f:for each="{coord}" as="poi" iteration="iterator">
	<f:if condition="{iterator.isLast}">
		<f:then>
			[{poi.0}, {poi.1}]
		</f:then>
		<f:else>
			[{poi.0}, {poi.1}],
		</f:else>
	</f:if>
</f:for>
]

DYGRAPH{currentNode}= [
<f:for each="{elevation}" as="value" iteration="iterator">
	<f:if condition="{iterator.isLast}">
		<f:then>
			[new Date("{value.0}"), {value.1}, {value.2}]
		</f:then>
		<f:else>
			[new Date("{value.0}"), {value.1}, {value.2}],
		</f:else>
	</f:if>
</f:for>
]

$(document).ready(function() {
	
	var mapId = $("#track{currentNode}");
	var path = eval('GMAP{currentNode}');
	$(mapId).gmap3({
		map:{
			center: true,
			zoom: 10,
		},
		polyline:{
			options:{
				strokeColor: "#FF0000",
				strokeOpacity: 1.0,
				strokeWeight: 1,
				path: path,
			}
		},
		autofit:{} 
	});

	var huhu = $("#track{currentNode}").attr('id');

	var map = $("#track{currentNode}").gmap3('get');
    var latLngDEF = new google.maps.LatLng(path[0][0], path[0][1]);

	var marker = new google.maps.Marker({
		position: latLngDEF,
		map: map,
		title: 'BikeMap'
	});
	
	new Dygraph(document.getElementById("graph{currentNode}"),
	          eval('DYGRAPH{currentNode}'),
	          {
	            labels: ["Date", "Elevation", "Speed km/h" ],
	            showRangeSelector: true,
				highlightCallback: function(e, x, pts, row) {
		            var latLng = new google.maps.LatLng(path[row][0], path[row][1]);
					map.setCenter(latLng);
				    marker.setPosition(latLng);
				},
	            series : {
	              'Date': { axis: 'y1' },
	              'Elevation': { axis: 'y2' }
	            },
	            axes: {
	              y2: {
	                // set axis-related properties here
	                labelsKMB: true
	              }
	            },
	            ylabel: 'Speed',
	            y2label: 'Elevation'
	          }
	);
});

</script>